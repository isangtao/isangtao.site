<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Voice Chat</title>
            <style>
                body {color: green; padding: 100px; background-color: black}
                h2 {color: #0f0}
                form {background: #111; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.5)}
                label {font-weight: bold; display: block; margin: 10px 0 5px; text-align: left; color: #0f0}
                input, select, textarea {width: 95%; padding: 10px; margin-bottom: 10px; border: 1px solid #0f0; border-radius: 4px; background-color: #222; color: #0f0}
                button {background: #0f0; color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer}
                button:hover {background: #00ff00}
                canvas {border: 1px solid #0f0; width: 100%; height: 150px; background-color: #222}
                p {white-space: pre-wrap; word-wrap: break-word}
            </style>
    </head>
    <body onload="Chat()">
        <h2>Converser</h2>        
        <p class="subtitle">Â© 2025 Michael Carlos</p>
        <p class="subtitle">(Set an environment variable OLLAMA_ORIGINS=*, then install Ollama and llama3.2)</p>
        <p id="prompt"></p>
        <p id="response"></p>
        <script>            
            async function Chat()
            {
                window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (window.SpeechRecognition) 
                {
                    const recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'en-US';

                    let silenceTimer;
                    j = 0;

                    recognition.onresult = (event) => 
                    {
                        prompt = document.getElementById('prompt');
                        response = document.getElementById('response');

                        clearTimeout(silenceTimer); // Reset silence timer on new input

                        let myprompt = '';
                        for (let i = j; i < event.results.length; i++) {
                            myprompt += event.results[i][0].transcript;
                        }
                        prompt.innerText = myprompt;
                        
                        // Start silence timer
                        silenceTimer = setTimeout(() => 
                        {
                            if (typeof controller !== 'undefined') controller.abort();
                            for (let k = 0; k < 100; k++) speechSynthesis.cancel();
                            Go(myprompt, response, true);
                            myprompt = '';
                            j = event.results.length;
                        }, 1000);
                    };

                    recognition.onend = () => {
                        recognition.start(); // Restart recognition automatically
                    };

                    recognition.start();
                } else {
                    alert("Your browser does not support Speech Recognition.");
                }
            }
                    
            function Speak(text) 
            {
                return new Promise((resolve, reject) => 
                {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.onend = resolve;
                utterance.onerror = reject;
                speechSynthesis.speak(utterance);
                });
            }

            async function Go(myprompt, output, voiceflag)
            {
                controller = new AbortController();
                const signal = controller.signal;

                const response = await fetch("http://localhost:11434/api/generate", {method: "POST", headers: {"Content-Type": "application/json", "Authorization": "Bearer 1234"}, body: JSON.stringify({model: "llama3.2", prompt: myprompt, stream: true, options: {temperature: 0.9}}),signal});

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                output.innerText = "";
                speechtext = "";

                while (true) 
                {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    chunktext = JSON.parse(chunk).response;
                    output.textContent += chunktext;
                    output.style.height = "auto";
                    output.style.height = (output.scrollHeight) + "px";
                    speechtext += chunktext;
                    if (chunktext == "." && voiceflag == true)
                    {
                        Speak(speechtext);
                        speechtext = "";
                    }
                }
            }

        </script>
    </body>
</html>
